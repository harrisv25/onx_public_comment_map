<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Public Comment Opportunities Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="version" content="v6"> <!-- bump this to force Pages cache refresh -->

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .mapboxgl-popup { max-width: 320px; }
    .mapboxgl-popup-content { font: 12px/1.4 'Helvetica Neue', Arial, Helvetica, sans-serif; }
    .legend, .filters {
      position: absolute; left: 20px;
      background: white; border-radius: 6px; padding: 8px 10px; font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1;
    }
    .legend { bottom: 20px; }
    .filters { top: 20px; display: flex; gap: 6px; flex-wrap: wrap; }
    .legend span { display: inline-block; width: 12px; height: 12px; margin-right: 6px; vertical-align: middle; }
    .filters button {
      border: 1px solid #ccc;
      background: #f9f9f9;
      padding: 4px 6px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
    }
    .filters button.active {
      background: #ddd;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="filters"></div>
  <div class="legend"></div>

  <script>
    // ✅ Your real public token (safe for GitHub Pages)
    mapboxgl.accessToken = "pk.eyJ1IjoiaGFycmlzdjI1IiwiYSI6ImNtN2JkZWdsdTBkbHoyaW9jN2lpeXlvemMifQ.3fqaKeVOa8lm4e2WJdl-Mg";
    console.log("[token prefix LIVE]", mapboxgl.accessToken.slice(0, 24) + "…");

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      center: [-105.5, 39.0],
      zoom: 5
    });

    map.addControl(new mapboxgl.NavigationControl());
    map.on("error", (e) => console.error("[Mapbox GL Error]", e?.error || e));

    const DATA_URL = "data/final_opportunities.geojson";

    map.on("load", async () => {
      const today = new Date();

      const parseDate = (s) => {
        if (!s || typeof s !== "string") return null;
        const d = new Date(s);
        return isNaN(d.getTime()) ? null : d;
      };

      // Status rules
      const getStatus = (startStr, endStr) => {
        const start = parseDate(startStr);
        const end = parseDate(endStr);
        if (start && end) {
          if (today >= start && today <= end) return "Active";
          if (today < start) return "Upcoming";
          if (today > end) return "Recently Closed";
        }
        if (start && !end) {
          if (today < start) return "Upcoming";
          if (today >= start) return "Active";
        }
        return "Unknown";
      };

      try {
        const res = await fetch(DATA_URL, { cache: "no-cache" });
        if (!res.ok) throw new Error(`Failed to fetch ${DATA_URL} (${res.status})`);
        const data = await res.json();

        data.features = (data.features || []).map((f) => {
          const p = f.properties || {};
          return { ...f, properties: { ...p, status: getStatus(p.start_date, p.end_date) } };
        });

        map.addSource("opps", { type: "geojson", data });

        map.addLayer({
          id: "opps-layer",
          type: "circle",
          source: "opps",
          paint: {
            "circle-radius": [
              "match", ["get", "status"],
              "Active", 7,
              "Upcoming", 6,
              "Recently Closed", 5,
              5
            ],
            "circle-color": [
              "match", ["get", "status"],
              "Active", "#ef4444",          // red
              "Upcoming", "#06b6d4",        // cyan
              "Recently Closed", "#f59e0b", // amber
              "Unknown", "#a3a3a3",
              "#a3a3a3"
            ],
            "circle-stroke-color": "#111",
            "circle-stroke-width": 1,
            "circle-opacity": [
              "match", ["get", "status"],
              "Unknown", 0.5,
              0.9
            ]
          }
        });

        // Popups
        map.on("click", "opps-layer", (e) => {
          const f = e.features?.[0];
          if (!f) return;
          const p = f.properties || {};
          const html = `
            <strong>${p.project_name || "(unnamed)"}</strong><br>
            <em>${p.source || ""}</em><br>
            <b>Status:</b> ${p.status}<br>
            <b>Start:</b> ${p.start_date || "?"}<br>
            <b>End:</b> ${p.end_date || "?"}<br>
            <div style="margin-top:6px;">${(p.notes || "").slice(0, 400)}</div>
          `;
          new mapboxgl.Popup({ offset: 12 })
            .setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map);
        });

        map.on("mouseenter", "opps-layer", () => (map.getCanvas().style.cursor = "pointer"));
        map.on("mouseleave", "opps-layer", () => (map.getCanvas().style.cursor = ""));

        // Fit bounds
        const coords = data.features
          .map(f => f?.geometry?.type === "Point" ? f.geometry.coordinates : null)
          .filter(Boolean);
        if (coords.length) {
          const bounds = coords.reduce(
            (b, c) => b.extend(c),
            new mapboxgl.LngLatBounds(coords[0], coords[0])
          );
          map.fitBounds(bounds, { padding: 40 });
        }

        // Legend
        document.querySelector(".legend").innerHTML = `
          <div style="font-weight:600;margin-bottom:4px;">Comment Status</div>
          <div><span style="background:#ef4444;"></span>Active</div>
          <div><span style="background:#06b6d4;"></span>Upcoming</div>
          <div><span style="background:#f59e0b;"></span>Recently Closed</div>
          <div><span style="background:#a3a3a3;"></span>Unknown</div>
        `;

        // Filters
        const categories = ["Active", "Upcoming", "Recently Closed", "Unknown"];
        const activeFilters = new Set(categories);
        const filtersDiv = document.querySelector(".filters");

        categories.forEach(cat => {
          const btn = document.createElement("button");
          btn.textContent = cat;
          btn.classList.add("active");
          btn.onclick = () => {
            if (activeFilters.has(cat)) {
              activeFilters.delete(cat);
              btn.classList.remove("active");
            } else {
              activeFilters.add(cat);
              btn.classList.add("active");
            }
            updateFilter();
          };
          filtersDiv.appendChild(btn);
        });

        function updateFilter() {
          if (activeFilters.size === 0) {
            map.setFilter("opps-layer", ["==", "status", "__none__"]);
          } else {
            map.setFilter("opps-layer", ["in", ["get", "status"], ["literal", Array.from(activeFilters)]]);
          }
        }
        updateFilter();
      } catch (err) {
        console.error("[Data Load Error]", err);
        alert("Failed to load map data. Check console for details.");
      }
    });
  </script>
</body>
</html>
