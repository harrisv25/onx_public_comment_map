<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Public Comment Opportunities Map</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Mapbox GL JS -->
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

  <style>
    html, body { margin: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .mapboxgl-popup { max-width: 320px; }
    .mapboxgl-popup-content { font: 12px/1.4 'Helvetica Neue', Arial, Helvetica, sans-serif; }
    .legend {
      position: absolute; bottom: 20px; left: 20px;
      background: white; border-radius: 6px; padding: 8px 10px; font-size: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1;
    }
    .legend span {
      display: inline-block; width: 12px; height: 12px; margin-right: 6px; vertical-align: middle;
    }
    .blm { background: #06b6d4; }
    .usfs { background: #22c55e; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="legend">
    <div><span class="blm"></span>BLM</div>
    <div><span class="usfs"></span>USFS</div>
  </div>

  <script>
    // ðŸ”‘ IMPORTANT: replace with your real public token that starts with "pk."
    mapboxgl.accessToken = "pk.REPLACE_ME_WITH_YOUR_PUBLIC_TOKEN";

    const map = new mapboxgl.Map({
      container: "map",
      style: "mapbox://styles/mapbox/light-v11",
      center: [-105.5, 39.0],
      zoom: 5
    });

    map.addControl(new mapboxgl.NavigationControl());

    // If index.html is in /docs, then /docs/data/... is correct:
    const DATA_URL = "data/final_opportunities.geojson";

    // Helpful: log map load errors (e.g., token issues)
    map.on("error", (e) => {
      console.error("[Mapbox GL Error]", e && e.error ? e.error : e);
    });

    map.on("load", async () => {
      try {
        const res = await fetch(DATA_URL, { cache: "no-cache" });
        if (!res.ok) {
          throw new Error(`Failed to fetch ${DATA_URL} (${res.status})`);
        }
        const data = await res.json();

        if (!data || !Array.isArray(data.features)) {
          throw new Error("GeoJSON loaded but has no 'features' array.");
        }

        map.addSource("opps", { type: "geojson", data });

        map.addLayer({
          id: "opps-layer",
          type: "circle",
          source: "opps",
          paint: {
            "circle-radius": 6,
            "circle-color": [
              "match",
              ["get", "source"],
              "BLM", "#06b6d4",
              "USFS", "#22c55e",
              /* other */ "#aaa"
            ],
            "circle-stroke-color": "#000",
            "circle-stroke-width": 1
          }
        });

        map.on("click", "opps-layer", (e) => {
          const f = e.features && e.features[0];
          if (!f) return;
          const p = f.properties || {};
          const html = `
            <strong>${p.project_name || "(unnamed)"}</strong><br>
            <em>${p.source || ""}</em><br>
            Start: ${p.start_date || "?"}<br>
            End: ${p.end_date || "?"}<br>
            <div style="margin-top:6px;">${(p.notes || "").slice(0, 400)}</div>
          `;
          new mapboxgl.Popup({ offset: 12 })
            .setLngLat(e.lngLat)
            .setHTML(html)
            .addTo(map);
        });

        map.on("mouseenter", "opps-layer", () => (map.getCanvas().style.cursor = "pointer"));
        map.on("mouseleave", "opps-layer", () => (map.getCanvas().style.cursor = ""));

        // Safe fitBounds if we have at least one Point
        const coords = data.features
          .map(f => f && f.geometry && f.geometry.type === "Point" ? f.geometry.coordinates : null)
          .filter(Boolean);

        if (coords.length > 0) {
          const bounds = coords.reduce((b, c) => b.extend(c), new mapboxgl.LngLatBounds(coords[0], coords[0]));
          map.fitBounds(bounds, { padding: 40 });
        } else {
          console.warn("No point features found; leaving default view.");
        }
      } catch (err) {
        console.error("[Data Load Error]", err);
        alert("Failed to load map data. Check the console for details.");
      }
    });
  </script>
</body>
</html>
