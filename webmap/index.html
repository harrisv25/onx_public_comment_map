<script>
  // Allow token via URL: webmap/index.html?token=pk.eyJ...
  const getTokenFromURL = () => {
    const u = new URL(window.location.href);
    return u.searchParams.get('token');
  };

  const INLINE_TOKEN_PLACEHOLDER = "${MAPBOX_TOKEN}"; // replace manually if you want
  const MAPBOX_TOKEN = getTokenFromURL() || (window.MAPBOX_TOKEN || INLINE_TOKEN_PLACEHOLDER);

  if (!MAPBOX_TOKEN || MAPBOX_TOKEN.includes("${MAPBOX_TOKEN}")) {
    console.warn("Mapbox token missing. Pass ?token=YOUR_TOKEN in the URL or replace ${MAPBOX_TOKEN} inline.");
  }
  mapboxgl.accessToken = MAPBOX_TOKEN;

  const map = new mapboxgl.Map({
    container: 'map',
    style: 'mapbox://styles/mapbox/outdoors-v12',
    center: [-105.5, 39.0],
    zoom: 5.6
  });

  map.addControl(new mapboxgl.NavigationControl(), 'top-right');

  async function loadData() {
    const resp = await fetch('data.json', { cache: 'no-cache' });
    if (!resp.ok) throw new Error(`Failed to load data.json: ${resp.status}`);
    return await resp.json();
  }

  function applyFilters() {
    const showActive = document.getElementById('f_active').checked;
    const showUpcoming = document.getElementById('f_upcoming').checked;
    const showClosed = document.getElementById('f_closed').checked;
    const statuses = [];
    if (showActive) statuses.push('active');
    if (showUpcoming) statuses.push('upcoming');
    if (showClosed) statuses.push('closed');
    // Filter by property value
    map.setFilter('opps-circles', ['in', ['get', 'comment_status'], ['literal', statuses]]);
  }

  (async () => {
    try {
      const geojson = await loadData();
      map.on('load', () => {
        map.addSource('opps', { type: 'geojson', data: geojson });

        map.addLayer({
          id: 'opps-circles',
          type: 'circle',
          source: 'opps',
          paint: {
            'circle-radius': 6,
            'circle-stroke-width': 1.5,
            'circle-stroke-color': '#222',
            'circle-color': [
              'match', ['get', 'comment_status'],
              'active', '#1DB954',
              'upcoming', '#FFC107',
              'closed', '#E53935',
              /* other */ '#607D8B'
            ]
          }
        });

        const popup = new mapboxgl.Popup({ closeButton: false, closeOnClick: false });

        map.on('mousemove', 'opps-circles', (e) => {
          map.getCanvas().style.cursor = 'pointer';
          const f = e.features[0];
          const p = f.properties;
          const html = `
            <div class="popup">
              <div class="title"><a href="${p.source_url}" target="_blank" rel="noopener">${p.title}</a></div>
              <div>${p.agency} · ${p.office_or_unit || '—'}</div>
              <div>Status: <b>${p.comment_status}</b></div>
              <div>Start: ${p.comment_start_date || '—'} · End: ${p.comment_end_date || '—'}</div>
            </div>`;
          popup.setLngLat(e.lngLat).setHTML(html).addTo(map);
        });
        map.on('mouseleave', 'opps-circles', () => {
          map.getCanvas().style.cursor = '';
          popup.remove();
        });

        ['f_active','f_upcoming','f_closed'].forEach(id => {
          document.getElementById(id).addEventListener('change', applyFilters);
        });
        applyFilters();
      });
    } catch (err) {
      console.error(err);
      alert('Could not load map data. Run `make map` and refresh, or check the console.');
    }
  })();
</script>
